<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OmniSense Operator</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; margin: 0; }
        .header { width: 100%; padding: 15px; background: #1f1f1f; text-align: center; font-weight: bold; border-bottom: 1px solid #333; }
        
        #login-box { margin-top: 100px; text-align: center; }
        input { padding: 10px; border-radius: 5px; border: none; width: 200px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        
        #call-interface { display: none; width: 400px; background: #2d2d2d; padding: 20px; border-radius: 10px; text-align: center; margin-top: 50px; border: 1px solid #444; }
        .pulse { animation: pulse 1.5s infinite; color: #dc3545; font-size: 50px; margin: 20px 0; }
        @keyframes pulse { 0% { transform: scale(0.95); opacity: 0.7; } 100% { transform: scale(1.1); opacity: 1; } }
        
        .info-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; }
    </style>
</head>
<body>
    <div class="header">OPERATOR PORTAL</div>

    <div id="login-box">
        <h3>Operator Login</h3>
        <input type="text" id="op-id" placeholder="Enter ID (e.g. op1)">
        <button onclick="joinPool()">Start Shift</button>
    </div>

    <div id="status" style="margin-top:20px; color:#aaa;">Offline</div>

    <div id="call-interface">
        <div style="color:#dc3545; font-weight:bold;">LIVE EMERGENCY</div>
        <div class="pulse"><i class="fas fa-phone-volume"></i></div>
        
        <div class="info-row"><span>CALLER:</span> <span id="c-phone">--</span></div>
        <div class="info-row"><span>LOCATION:</span> <span id="c-loc">--</span></div>
        <div class="info-row"><span>SEVERITY:</span> <span id="c-sev">--</span></div>
        <div class="info-row"><span>SUMMARY:</span> <span id="c-sum" style="font-size:0.8em">--</span></div>
        
        <div style="margin-top:20px; font-size:0.8rem; color:#888;">2-WAY AUDIO ACTIVE</div>
        <button onclick="endCall()" style="background:#dc3545; margin-top:15px;">End Call</button>
    </div>

    <script>
        let ws;
        let audioContext;
        
        async function joinPool() {
            const opId = document.getElementById('op-id').value;
            if(!opId) return alert("Enter ID");
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: { sampleRate: 16000 } });
                setupAudio(stream);
            } catch(e) {
                return alert("Microphone access required!");
            }

            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            ws = new WebSocket(`${protocol}://${window.location.host}/ws/operator/${opId}`);
            
            ws.onopen = () => {
                document.getElementById('login-box').style.display = 'none';
                document.getElementById('status').innerText = "✅ ONLINE - Waiting for calls...";
                document.getElementById('status').style.color = "#00cc00";
            };

            ws.onmessage = async (event) => {
                if (event.data instanceof Blob) {
                    playAudio(await event.data.arrayBuffer());
                } else {
                    const data = JSON.parse(event.data);
                    if (data.type === 'new_assignment') {
                        showCall(data);
                    } else if (data.type === 'call_ended') {
                        hideCall();
                    }
                }
            };
        }

        function showCall(data) {
            document.getElementById('call-interface').style.display = 'block';
            document.getElementById('status').innerText = "⚠️ ON CALL";
            document.getElementById('status').style.color = "#dc3545";
            document.getElementById('c-phone').innerText = data.caller_id;
            document.getElementById('c-loc').innerText = data.location;
            document.getElementById('c-sev').innerText = data.severity;
            document.getElementById('c-sum').innerText = data.summary;
        }

        function hideCall() {
            document.getElementById('call-interface').style.display = 'none';
            document.getElementById('status').innerText = "✅ ONLINE - Waiting for calls...";
            document.getElementById('status').style.color = "#00cc00";
        }
        
        function endCall() {
            // For now, this is visual only. The Dashboard "Complete" button triggers the API.
            // In a real app, this would send an API request too.
            alert("Please mark complete from Dashboard (or implement API call here)");
        }

        function setupAudio(stream) {
            audioContext = new AudioContext({ sampleRate: 16000 });
            const source = audioContext.createMediaStreamSource(stream);
            const processor = audioContext.createScriptProcessor(4096, 1, 1);
            
            processor.onaudioprocess = (e) => {
                if(ws && ws.readyState === WebSocket.OPEN) {
                    const inputData = e.inputBuffer.getChannelData(0);
                    const buffer = new Int16Array(inputData.length);
                    for (let i = 0; i < inputData.length; i++) {
                        let s = Math.max(-1, Math.min(1, inputData[i]));
                        buffer[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                    }
                    ws.send(buffer.buffer);
                }
            };
            source.connect(processor);
            processor.connect(audioContext.destination);
        }

        function playAudio(arrayBuffer) {
            const float32 = new Float32Array(arrayBuffer.byteLength / 2);
            const dataView = new DataView(arrayBuffer);
            for (let i = 0; i < float32.length; i++) {
                float32[i] = dataView.getInt16(i * 2, true) / 32768.0;
            }
            const buffer = audioContext.createBuffer(1, float32.length, 16000);
            buffer.getChannelData(0).set(float32);
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);
            source.start();
        }
    </script>
</body>
</html>